<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chillamp Selector</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f4f4f4; }
    h1 { color: #333; }
    label { display: block; margin-top: 1rem; }
    select, input[type="submit"], button { padding: 0.5rem; margin-top: 0.25rem; width: 100%; max-width: 400px; }
    #effets { max-width: 400px; background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 5px; max-height: 300px; overflow-y: auto; }
    pre { background: #222; color: #eee; padding: 1rem; margin-top: 2rem; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h1>Chillamp Selector</h1>

  <form id="presetForm">
    <label for="bassiste">Bassiste</label>
    <select id="bassiste" required></select>

    <label for="basse">Basse</label>
    <select id="basse" required></select>

    <label for="ampli">Ampli</label>
    <select id="ampli" required></select>

    <label>Effets</label>
    <div id="effets"></div>

    <label for="baffle">Baffle</label>
    <select id="baffle" required></select>

    <input type="submit" value="Générer le preset">
    <button type="button" onclick="downloadPDF()">Télécharger le PDF</button>
  </form>

  <pre id="result"></pre>

  <script>
    async function fetchAndPopulate(id, endpoint) {
      try {
        const res = await fetch(endpoint);
        const data = await res.json();
        const select = document.getElementById(id);
        data.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item;
          opt.textContent = item;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error('Erreur lors du fetch:', error);
      }
    }

    async function fetchAndRenderCheckboxes(id, endpoint) {
      try {
        const res = await fetch(endpoint);
        const data = await res.json();
        const container = document.getElementById(id);
        data.forEach(effet => {
          const label = document.createElement('label');
          label.style.display = "block";
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.name = 'effets';
          input.value = effet;
          label.appendChild(input);
          label.appendChild(document.createTextNode(' ' + effet));
          container.appendChild(label);
        });
      } catch (error) {
        console.error('Erreur lors du fetch des effets:', error);
      }
    }

    fetchAndPopulate('bassiste', '/api/liste_bassistes');
    fetchAndPopulate('basse', '/api/liste_basses');
    fetchAndPopulate('ampli', '/api/liste_amplis');
    fetchAndRenderCheckboxes('effets', '/api/liste_effets');
    fetchAndPopulate('baffle', '/api/liste_baffles');

    document.getElementById('presetForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const bassiste = document.getElementById('bassiste').value;
      const basse = document.getElementById('basse').value;
      const ampli = document.getElementById('ampli').value;
      const effets = Array.from(document.querySelectorAll('#effets input:checked')).map(e => e.value);
      const baffle = document.getElementById('baffle').value;

      try {
        const response = await fetch('/api/preset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bassiste, basse, ampli, effets, baffle })
        });
        const data = await response.json();
        document.getElementById('result').textContent = JSON.stringify(data, null, 2);
      } catch (error) {
        console.error('Erreur lors de la génération du preset:', error);
      }
    });

    async function downloadPDF() {
      const bassiste = document.getElementById('bassiste').value;
      const basse = document.getElementById('basse').value;
      const ampli = document.getElementById('ampli').value;
      const effets = Array.from(document.querySelectorAll('#effets input:checked')).map(e => e.value);
      const baffle = document.getElementById('baffle').value;

      try {
        const response = await fetch('/api/preset/pdf', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bassiste, basse, ampli, effets, baffle })
        });
        const blob = await response.blob();
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'preset_chillamp.pdf';
        link.click();
      } catch (error) {
        console.error('Erreur lors du téléchargement du PDF:', error);
      }
    }
  </script>
</body>
</html>
